generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["tutorboard", "hub"]
}

// ===== HUB AUTH (읽기 전용) =====

model auth_member {
  id                    String          @id @db.VarChar(30)
  email                 String          @db.VarChar(500)
  password              String?         @db.VarChar(500)
  role_type             String?         @db.VarChar(500)
  phone                 String?         @db.VarChar(255)
  nickname              String?         @db.VarChar(255)
  member_type           String?         @db.VarChar(20)
  provider_type         String?         @db.VarChar(20)
  create_dt             DateTime?       @db.Timestamp(6)
  update_dt             DateTime?       @db.Timestamp(6)

  auth_member_s         auth_member_s?

  @@index([email, phone], map: "idx_auth_member_email_phone")
  @@schema("hub")
}

model auth_member_s {
  member_id       String      @id @db.VarChar(30)
  school_code     String?     @db.VarChar(20)
  school_name     String?     @db.VarChar(100)
  school_location String?     @db.VarChar(50)
  school_type     String?     @db.VarChar(50)
  school_level    String?     @db.VarChar(10)
  grade           Int?
  auth_member     auth_member @relation(fields: [member_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("hub")
}

// ===== TUTORBOARD ENUMS =====

enum UserRole {
  teacher
  parent
  student

  @@schema("tutorboard")
}

enum SubmissionStatus {
  pending
  submitted
  graded

  @@schema("tutorboard")
}

enum PaymentStatus {
  pending
  paid
  overdue

  @@schema("tutorboard")
}

enum NotificationType {
  assignment
  test
  payment
  attendance
  comment
  general

  @@schema("tutorboard")
}

enum AttendanceStatus {
  present
  late
  absent

  @@schema("tutorboard")
}

// ===== TUTORBOARD USERS =====

model TbUser {
  id         String   @id @default(uuid())
  hubUserId  Int?     @unique @map("hub_user_id")
  username   String
  email      String   @unique
  role       UserRole
  phone      String?
  avatarUrl  String?  @map("avatar_url")
  createdAt  DateTime @default(now()) @map("created_at")

  teacherClasses       TbClass[]
  studentEnrollments   TbClassEnrollment[] @relation("StudentEnrollments")
  parentEnrollments    TbClassEnrollment[] @relation("ParentEnrollments")
  submissions          TbAssignmentSubmission[]
  testResults          TbTestResult[]
  studentPayments      TbPayment[]
  notifications        TbNotification[]
  badges               TbStudentBadge[]
  attendances          TbAttendance[]
  sentComments         TbPrivateComment[]    @relation("CommentAuthor")
  receivedComments     TbPrivateComment[]    @relation("CommentTarget")
  sentMessages         TbMessage[]

  @@map("tb_users")
  @@schema("tutorboard")
}

// ===== TUTORBOARD CLASSES =====

model TbClass {
  id          String   @id @default(uuid())
  teacherId   String   @map("teacher_id")
  name        String
  subject     String   @default("기타")
  description String?
  inviteCode  String   @unique @map("invite_code")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  createdAt   DateTime @default(now()) @map("created_at")

  teacher     TbUser         @relation(fields: [teacherId], references: [id])
  enrollments TbClassEnrollment[]
  lessonPlans TbLessonPlan[]
  payments    TbPayment[]
  attendances TbAttendance[]

  @@map("tb_classes")
  @@schema("tutorboard")
}

model TbClassEnrollment {
  id         String   @id @default(uuid())
  classId    String   @map("class_id")
  studentId  String   @map("student_id")
  parentId   String?  @map("parent_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at")

  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation("StudentEnrollments", fields: [studentId], references: [id])
  parent  TbUser? @relation("ParentEnrollments", fields: [parentId], references: [id])

  @@unique([classId, studentId])
  @@map("tb_class_enrollments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD LESSON PLANS & RECORDS =====

model TbLessonPlan {
  id            String   @id @default(uuid())
  classId       String   @map("class_id")
  title         String
  description   String?
  scheduledDate DateTime? @map("scheduled_date")
  progress      Int      @default(0)
  updatedAt     DateTime @updatedAt @map("updated_at")

  class       TbClass          @relation(fields: [classId], references: [id])
  assignments TbAssignment[]
  tests       TbTest[]
  records     TbLessonRecord[]

  @@map("tb_lesson_plans")
  @@schema("tutorboard")
}

model TbLessonRecord {
  id           String   @id @default(uuid())
  lessonPlanId String   @map("lesson_plan_id")
  recordDate   DateTime @map("record_date")
  summary      String?
  pagesFrom    Int?     @map("pages_from")
  pagesTo      Int?     @map("pages_to")
  conceptNote  String?  @map("concept_note")
  fileUrl      String?  @map("file_url")
  createdAt    DateTime @default(now()) @map("created_at")

  lessonPlan TbLessonPlan @relation(fields: [lessonPlanId], references: [id])

  @@map("tb_lesson_records")
  @@schema("tutorboard")
}

// ===== TUTORBOARD ATTENDANCE =====

model TbAttendance {
  id        String           @id @default(uuid())
  classId   String           @map("class_id")
  studentId String           @map("student_id")
  date      DateTime
  status    AttendanceStatus @default(present)
  note      String?
  createdAt DateTime         @default(now()) @map("created_at")

  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation(fields: [studentId], references: [id])

  @@unique([classId, studentId, date])
  @@map("tb_attendances")
  @@schema("tutorboard")
}

// ===== TUTORBOARD ASSIGNMENTS =====

model TbAssignment {
  id          String   @id @default(uuid())
  lessonId    String   @map("lesson_id")
  title       String
  description String?
  dueDate     DateTime? @map("due_date")
  fileUrl     String?  @map("file_url")
  createdAt   DateTime @default(now()) @map("created_at")

  lesson      TbLessonPlan          @relation(fields: [lessonId], references: [id])
  submissions TbAssignmentSubmission[]

  @@map("tb_assignments")
  @@schema("tutorboard")
}

model TbAssignmentSubmission {
  id                String           @id @default(uuid())
  assignmentId      String           @map("assignment_id")
  studentId         String           @map("student_id")
  submissionFileUrl String?          @map("submission_file_url")
  feedback          String?
  grade             Int?
  status            SubmissionStatus @default(pending)
  submittedAt       DateTime         @default(now()) @map("submitted_at")

  assignment TbAssignment @relation(fields: [assignmentId], references: [id])
  student    TbUser       @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@map("tb_assignment_submissions")
  @@schema("tutorboard")
}

// ===== TUTORBOARD TESTS =====

model TbTest {
  id          String   @id @default(uuid())
  lessonId    String   @map("lesson_id")
  title       String
  description String?
  testDate    DateTime? @map("test_date")
  maxScore    Int      @map("max_score")
  createdAt   DateTime @default(now()) @map("created_at")

  lesson  TbLessonPlan   @relation(fields: [lessonId], references: [id])
  results TbTestResult[]

  @@map("tb_tests")
  @@schema("tutorboard")
}

model TbTestResult {
  id              String   @id @default(uuid())
  testId          String   @map("test_id")
  studentId       String   @map("student_id")
  score           Int
  feedback        String?
  wrongAnswerNote String?  @map("wrong_answer_note")
  takenAt         DateTime @default(now()) @map("taken_at")

  test    TbTest @relation(fields: [testId], references: [id])
  student TbUser @relation(fields: [studentId], references: [id])

  @@unique([testId, studentId])
  @@map("tb_test_results")
  @@schema("tutorboard")
}

// ===== TUTORBOARD PAYMENTS =====

model TbPayment {
  id         String        @id @default(uuid())
  classId    String        @map("class_id")
  studentId  String        @map("student_id")
  amount     Decimal
  dueDate    DateTime      @map("due_date")
  paidDate   DateTime?     @map("paid_date")
  status     PaymentStatus @default(pending)
  receiptUrl String?       @map("receipt_url")
  createdAt  DateTime      @default(now()) @map("created_at")

  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation(fields: [studentId], references: [id])

  @@map("tb_payments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD NOTIFICATIONS =====

model TbNotification {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  message       String
  type          NotificationType @default(general)
  read          Boolean          @default(false)
  referenceId   String?          @map("reference_id")
  referenceType String?          @map("reference_type")
  sentAt        DateTime         @default(now()) @map("sent_at")

  user TbUser @relation(fields: [userId], references: [id])

  @@map("tb_notifications")
  @@schema("tutorboard")
}

// ===== TUTORBOARD PRIVATE COMMENTS =====

model TbPrivateComment {
  id          String   @id @default(uuid())
  authorId    String   @map("author_id")
  targetId    String   @map("target_id")
  studentId   String?  @map("student_id")
  contextType String?  @map("context_type")
  contextId   String?  @map("context_id")
  content     String
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")

  author TbUser @relation("CommentAuthor", fields: [authorId], references: [id])
  target TbUser @relation("CommentTarget", fields: [targetId], references: [id])

  @@map("tb_private_comments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD MESSAGING =====

model TbConversation {
  id        String   @id @default(uuid())
  teacherId String   @map("teacher_id")
  parentId  String   @map("parent_id")
  studentId String?  @map("student_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  messages TbMessage[]

  @@unique([teacherId, parentId, studentId])
  @@map("tb_conversations")
  @@schema("tutorboard")
}

model TbMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String
  contextType    String?  @map("context_type")
  contextId      String?  @map("context_id")
  read           Boolean  @default(false)
  sentAt         DateTime @default(now()) @map("sent_at")

  conversation TbConversation @relation(fields: [conversationId], references: [id])
  sender       TbUser         @relation(fields: [senderId], references: [id])

  @@map("tb_messages")
  @@schema("tutorboard")
}

// ===== TUTORBOARD BADGES =====

model TbStudentBadge {
  id        String   @id @default(uuid())
  studentId String   @map("student_id")
  badgeType String   @map("badge_type")
  badgeName String   @map("badge_name")
  earnedAt  DateTime @default(now()) @map("earned_at")

  student TbUser @relation(fields: [studentId], references: [id])

  @@map("tb_student_badges")
  @@schema("tutorboard")
}
